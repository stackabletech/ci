---
- job:
    name: update-deletable-self-service-clusters
    project-type: freestyle
    defaults: global
    description: ''
    disabled: false
    display-name: 'Update Deletable Self Service Clusters'
    concurrent: true
    quiet-period: 5
    logrotate:
      daysToKeep: -1
      numToKeep: 20
      artifactDaysToKeep: -1
      artifactNumToKeep: -1
    wrappers:
      - credentials-binding:
          - text:
              credential-id: T2_TOKEN
              variable: T2_TOKEN
    triggers:
      - timed: "H/5 * * * *"
    builders:
      - shell: 
          unstable-return: 255
          command: |
            # ---------------------------------------------------------------------------------------------
            # This Jenkins job has been generated by the Stackable CI Testing Toolbox
            # ---------------------------------------------------------------------------------------------

            cat << PYTHON_SCRIPT_EOF > run.py
            import os

            cluster_ids = []
            nicknames = []

            for file in os.listdir('/var/jenkins_home/workspace/delete-cluster-common-self-service/clusters/'):
                with open (f"/var/jenkins_home/workspace/delete-cluster-common-self-service/clusters/{file}", "r") as f:
                    cluster_ids.append(file)
                    nicknames.append(f.readline().strip().replace(",", "_"))

            with open (f"/var/jenkins_home/workspace/delete-cluster-common-self-service/clusters.properties", "w") as f:
                f.write("cluster_ids=")
                f.write(",".join(cluster_ids))
                f.write("\n")
                f.write("descriptions=")
                f.write(",".join(nicknames))
                f.write("\n")
            PYTHON_SCRIPT_EOF
            python3 run.py
