---
- job:
    name: delete-cluster-common-self-service
    project-type: freestyle
    defaults: global
    description: ''
    disabled: false
    display-name: 'Delete Self Service Cluster'
    concurrent: true
    quiet-period: 5
    logrotate:
      daysToKeep: -1
      numToKeep: 20
      artifactDaysToKeep: -1
      artifactNumToKeep: -1
    parameters:
      - extended-choice:
          name: CLUSTER_ID
          type: radio
          description: Which cluster should be deleted?
          property-file: /var/jenkins_home/workspace/delete-cluster-common-self-service/clusters.properties
          property-key: cluster_ids
          description-property-file: /var/jenkins_home/workspace/delete-cluster-common-self-service/clusters.properties
          description-property-key: descriptions
          quote-value: false
          visible-items: 100
    wrappers:
      - credentials-binding:
          - text:
              credential-id: T2_TOKEN
              variable: T2_TOKEN
    builders:
      - shell: 
          unstable-return: 255
          command: |
            # ---------------------------------------------------------------------------------------------
            # This Jenkins job has been generated by the Stackable CI Testing Toolbox
            # ---------------------------------------------------------------------------------------------

            # We're using Docker from within a Docker container, so we have to make sure to provide
            # the Docker daemon with the proper absolute path for volume mounts.
            # HOST_WORKSPACE is the absolute path of this job's workspace folder as used on the actual Docker host.
            export HOST_WORKSPACE=`echo $WORKSPACE | sed 's~jenkins_home~jenkins/data~'`

            # The T2 testdriver Docker image we're using is running under root (and must do so), so
            # we're providing it with a User/Group ID so that it can write the output files using this User/Group.
            # Otherwise we might end up with root-owned files which cannot be cleaned up by Jenkins
            export DOCKER_UID_GID="$(id -u):$(id -g)"

            # Pull the testdriver Docker image
            docker pull docker.stackable.tech/t2-testdriver:latest

            # Run testdriver
            mkdir -p testsuite/target/
            docker run --rm \
                --volume "$HOST_WORKSPACE/testsuite/target/:/target/" \
                --env CLUSTER=DELETE \
                --env CLUSTER_ID=$CLUSTER_ID \
                --env T2_TOKEN=$T2_TOKEN \
                --env T2_URL=https://api.t2.stackable.tech \
                --env UID_GID=$DOCKER_UID_GID \
                docker.stackable.tech/t2-testdriver:latest

            rm -rf "/var/jenkins_home/workspace/delete-cluster-common-self-service/clusters/${CLUSTER_ID}"
